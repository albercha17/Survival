<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Survival ¬∑ Cl√°sico</title>

<style>
* {
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
}

body {
    margin: 0;
    min-height: 100vh;
    background: radial-gradient(circle at top, #1c1c1c, #0a0a0a);
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
}

.app {
    width: 100%;
    max-width: 390px;
    padding: 24px 18px;
    text-align: center;
}

h2 {
    margin-bottom: 16px;
    letter-spacing: 3px;
}

button {
    width: 100%;
    padding: 16px;
    margin-bottom: 12px;
    font-size: 1.1rem;
    letter-spacing: 2px;
    background: linear-gradient(#1f1f1f, #141414);
    color: #fff;
    border: 2px solid #555;
    border-radius: 16px;
}

button:active { transform: scale(0.97); }

input {
    width: 100%;
    padding: 14px;
    margin-bottom: 12px;
    background: #111;
    color: #fff;
    border: 2px solid #444;
    border-radius: 12px;
}

.hidden { display: none; }

.player {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid #333;
}

.remove {
    background: none;
    border: none;
    color: #ff6666;
    font-size: 1.3rem;
}

.survivors {
    font-size: 0.8rem;
    opacity: 0.85;
    margin-bottom: 12px;
}

.card {
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 22px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 22px;
    margin: 16px 0 24px;
    font-size: 1.15rem;
}

.icon {
    font-size: 2.6rem;
    margin-bottom: 14px;
}

.muerte { background:#5a1a1a; }
.asesinato { background:#7a1212; }
.accion { background:#1f3a5a; }
.solo { background:#2f4f2f; }
.mundo { background:#3a3a3a; }
.final { background:#3a1f5a; }
.victoria { background:#6b5b1a; }
</style>
</head>

<body>

<div class="app">

<div id="select">
    <h2>MODO CL√ÅSICO</h2>
    <div id="lists"></div>
    <button onclick="activateFree()">LIBRE</button>
    <button onclick="goMenu()">‚Üê VOLVER</button>
</div>

<div id="setup" class="hidden">
    <button onclick="goBack()">‚Üê VOLVER</button>
    <div id="freeInput" class="hidden">
        <input id="nameInput" placeholder="Nombre del jugador">
        <button onclick="addPlayer()">A√ëADIR</button>
    </div>
    <div id="players"></div>
    <button onclick="startGame()">EMPEZAR</button>
</div>

<div id="game" class="hidden">
    <button onclick="exitGame()">SALIR DE LA PARTIDA</button>
    <div class="survivors" id="survivors"></div>

    <div id="card" class="card mundo">
        <div class="icon" id="icon">üåç</div>
        <div id="text">Pulsa SIGUIENTE</div>
    </div>

    <button id="nextBtn" onclick="nextStep()">SIGUIENTE</button>
    <button id="restartBtn" class="hidden" onclick="restart()">REINICIAR</button>
    <button id="menuBtn" class="hidden" onclick="goMenu()">MEN√ö PRINCIPAL</button>
</div>

</div>

<script>
// ================= CONFIG =================
const LISTS_PATH = "../listas/";
const LIST_INDEX = LISTS_PATH + "listas.json";
const ACTIONS_PATH = "../acciones/";

// ================= DOM =================
const select = document.getElementById("select");
const setup = document.getElementById("setup");
const game = document.getElementById("game");
const freeInput = document.getElementById("freeInput");
const nameInput = document.getElementById("nameInput");
const playersEl = document.getElementById("players");
const survivors = document.getElementById("survivors");
const card = document.getElementById("card");
const icon = document.getElementById("icon");
const textEl = document.getElementById("text");
const nextBtn = document.getElementById("nextBtn");
const restartBtn = document.getElementById("restartBtn");
const menuBtn = document.getElementById("menuBtn");

// ================= STATE =================
let players = [];
let initialPlayers = [];
let duelActive = false;
let duelPlayers = [];
let duelStep = 0;
let duelLoser = null;

// ================= EVENTS =================
let events = { muerte:[], asesinato:[], accion:[], solo:[], mundo:[] };
let duelActions = [];
let duelDeaths = [];

const icons = {
    muerte:"üíÄ", asesinato:"üî™", accion:"ü§ù",
    solo:"üßç", mundo:"üåç", final:"‚öîÔ∏è", victoria:"üëë"
};

// ================= LOAD ACTIONS =================
async function loadActions() {
    const map = {
        muerte:"muerte.json",
        asesinato:"asesinato.json",
        accion:"accion.json",
        solo:"solo.json",
        mundo:"mundo.json"
    };

    for (const t in map) {
        const res = await fetch(ACTIONS_PATH + map[t]);
        events[t] = await res.json();
    }

    duelActions = await (await fetch(ACTIONS_PATH + "duelo_acciones.json")).json();
    duelDeaths = await (await fetch(ACTIONS_PATH + "duelo_muertes.json")).json();
}

// ================= POOLS =================
const pools = {};
let duelActionPool = [];
let duelDeathPool = [];

function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} }

function initPools(){
    for(const t in events){ pools[t]=[...events[t]]; shuffle(pools[t]); }
    duelActionPool=[...duelActions]; shuffle(duelActionPool);
    duelDeathPool=[...duelDeaths]; shuffle(duelDeathPool);
}

function getEvent(t){ if(!pools[t].length){pools[t]=[...events[t]];shuffle(pools[t]);} return pools[t].pop(); }
function getDuelAction(){ if(!duelActionPool.length){duelActionPool=[...duelActions];shuffle(duelActionPool);} return duelActionPool.pop(); }
function getDuelDeath(){ if(!duelDeathPool.length){duelDeathPool=[...duelDeaths];shuffle(duelDeathPool);} return duelDeathPool.pop(); }

// ================= LISTS =================
async function loadLists(){
    const files = await (await fetch(LIST_INDEX)).json();
    const c = document.getElementById("lists");
    c.innerHTML="";
    files.forEach(f=>{
        const b=document.createElement("button");
        b.textContent=f.replace(".txt","").replace(/([a-z])([A-Z])/g,"$1 $2").toUpperCase();
        b.onclick=()=>loadList(f);
        c.appendChild(b);
    });
}

async function loadList(f){
    players=(await (await fetch(LISTS_PATH+f)).text()).split("\n").map(x=>x.trim()).filter(Boolean);
    showSetup();
}

function activateFree(){ players=[]; showSetup(); freeInput.classList.remove("hidden"); }

// ================= SETUP =================
function showSetup(){ select.classList.add("hidden"); setup.classList.remove("hidden"); renderPlayers(); }
function renderPlayers(){ playersEl.innerHTML=""; players.forEach((p,i)=>playersEl.innerHTML+=`<div class="player">${p}<button class="remove" onclick="removePlayer(${i})">‚ùå</button></div>`); }
function addPlayer(){ if(nameInput.value.trim()){ players.push(nameInput.value.trim()); nameInput.value=""; renderPlayers(); } }
function removePlayer(i){ players.splice(i,1); renderPlayers(); }
function goBack(){ players=[]; setup.classList.add("hidden"); select.classList.remove("hidden"); freeInput.classList.add("hidden"); }

// ================= GAME =================
function startGame(){
    initialPlayers=[...players];
    initPools();
    setup.classList.add("hidden");
    game.classList.remove("hidden");
    updateSurvivors();
}

function nextStep(){
    if(duelActive){
        if(duelStep===0){ renderCard("final",`‚öîÔ∏è Duelo entre ${duelPlayers[0]} y ${duelPlayers[1]}`); duelStep++; return; }
        if(duelStep<4){
            renderCard("final",getDuelAction().replace("{A}",duelPlayers[0]).replace("{B}",duelPlayers[1]));
            duelStep++; return;
        }
        if(!duelLoser){
            const winner=random(duelPlayers);
            duelLoser=duelPlayers.find(p=>p!==winner);
            players=[winner];
            updateSurvivors();
            renderCard("muerte",getDuelDeath().replace("{A}",winner).replace("{B}",duelLoser));
            return;
        }
        duelActive=false; checkEnd(); return;
    }

    if(players.length===2){ duelActive=true; duelPlayers=[...players]; duelStep=0; duelLoser=null; nextStep(); return; }
    if(players.length<=1) return;

    const types=["muerte","accion","solo","mundo","asesinato"];
    const type=random(types);
    let dead=null, text="";

    if(type==="muerte"){ dead=random(players); text=getEvent("muerte").replace("{A}",dead); }
    if(type==="accion"){
        const A=random(players), B=random(players.filter(p=>p!==A));
        text=getEvent("accion").replace("{A}",A).replace("{B}",B);
    }
    if(type==="solo"){ text=getEvent("solo").replace("{A}",random(players)); }
    if(type==="mundo"){ text=getEvent("mundo"); }
    if(type==="asesinato"){
        const A=random(players), B=random(players.filter(p=>p!==A));
        dead=B;
        text=getEvent("asesinato").replace("{A}",A).replace("{B}",B);
    }

    if(dead){ players=players.filter(p=>p!==dead); updateSurvivors(); }
    renderCard(type,text);
    checkEnd();
}

function renderCard(type,text){
    card.className=`card ${type}`;
    icon.textContent=icons[type];
    textEl.textContent=text;
}

function updateSurvivors(){ survivors.textContent=players.join(" ¬∑ "); }

function checkEnd(){
    if(players.length===1){
        renderCard("victoria",`${players[0]} es el √∫nico superviviente`);
        nextBtn.classList.add("hidden");
        restartBtn.classList.remove("hidden");
        menuBtn.classList.remove("hidden");
    }
}

function restart(){
    players=[...initialPlayers];
    duelActive=false;
    initPools();
    updateSurvivors();
    renderCard("mundo","Pulsa SIGUIENTE");
    nextBtn.classList.remove("hidden");
    restartBtn.classList.add("hidden");
    menuBtn.classList.add("hidden");
}

function goMenu(){ location.href="../index.html"; }
function exitGame(){ if(confirm("¬øSalir de la partida?")) location.href="../index.html"; }
function random(a){ return a[Math.floor(Math.random()*a.length)]; }

// ================= INIT =================
(async()=>{ await loadActions(); loadLists(); })();
</script>

</body>
</html>
